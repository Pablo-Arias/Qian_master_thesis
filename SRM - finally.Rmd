---
title: "SRM"
author: "Qian"
date: "2025-03-18"
output: html_document
---

# Load the tidyverse package below
```{r T101, warning=FALSE, message=FALSE}
# Load the tidyverse package below
cat("\f")
rm(list=ls())

# Init
graphics.off()

#install.packages("ez")
#("phia")
#install.packages("effsize")
#install.packages("srm")
#install.packages("TripleR")
library("MASS")
library(ez)
library(afex)
library(phia)
library(doBy)
library(effsize)
library(lmerTest);
library(dplyr);
library(srm);
library(ggplot2)
library(TripleR)
library(tidyverse)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))


#Import data
file_name = "data/behavior/all_data_df.csv"

#read data
data = read.table(file_name, header=TRUE,sep=',')
head(data)

#defining outcomes
measure			          <-as.numeric(data$measure)

#defining predictors (categorical)
participant_condition 	<- as.factor(data$participant_condition)
participant_condition   <- relevel(participant_condition, "S")
other_condition 		    <- as.factor(data$other_condition)
other_condition         <- relevel(other_condition, "S")
participant_nb			    <- as.factor(data$user_id)
interacting_partner			<- as.factor(data$other_id)
question_content		    <- as.factor(data$question_content)
group_id		            <- as.factor(data$sid)

#create new dataframe
all_data=data.frame( measure, participant_condition , interacting_partner, other_condition, participant_nb, question_content, group_id )

## -------------------------------------- ##
## -------------------------------------- ##
## GLMM Analysis ------------------------ ##
## -------------------------------------- ##
## -------------------------------------- ##

# Choose the question you want to anlayse
#question = "conversation_quality"
#question = "liked"
question = "other_liked"
#question = "video_conf_quality"

clean_data <- all_data[all_data$question_content == question,]
head(clean_data)


#Social relation Model
RR.style("perception")

#Round Robin
RR1 <- RR(measure ~ participant_nb * interacting_partner | group_id, data = clean_data, na.rm = TRUE)
RR1


#Missing values
plot_missings(measure ~ participant_nb * interacting_partner | group_id, data = clean_data, show.ids = FALSE)

#Variance covariance
plot(RR1)


RR1$effects #measure perceiver and target
RR1$effectsRel

result_file = paste("data/behavior/srm/",question,".csv", sep="")
write.csv(RR1$effectsRel, result_file) #Relationships

# ä¿å­˜ perceiver & target effects
result_file_effects <- paste("data/behavior/srm/", question, "_effects.csv", sep = "")
write.csv(RR1$effects, result_file_effects, row.names = FALSE)

#ä¿å­˜æ–¹å·®
RR1$varComp.groups
result_file_variance <- paste("data/behavior/srm/", question, "_variance.csv", sep = "")
write.csv(RR1$VAR, result_file_variance, row.names = FALSE)

df = data(likingLong)


str(likingLong)

# Load required libraries
library(lme4)
library(ggplot2)

# Function to run GLMM for each SRM dataset
run_srm_glmm <- function(data, title) {
  # Ensure factors are properly set
  data$participant_condition <- as.factor(data$participant_condition)
  data$other_condition <- as.factor(data$other_condition)

  # Run the GLMM
  glmm_model <- lmer(relationship ~ participant_condition * other_condition + 
                      (1 | participant_nb) + (1 | interacting_partner), 
                      data = data)
  
  # Print summary
  print(summary(glmm_model))
  
  # Plot results
  ggplot(data, aes(x = participant_condition, y = relationship, color = other_condition)) +
    geom_point(alpha = 0.3, position = position_jitter(width = 0.2)) +
    stat_summary(fun = mean, geom = "point", size = 4, position = position_dodge(0.2)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(0.2)) +
    labs(title = title, x = "Participant Condition", y = "Relationship Rating (SRM)") +
    scale_color_manual(values = c("red", "blue")) +
    theme_minimal()
}


# Load datasets
liked <- read_csv("data/behavior/srm/liked.csv")
other_liked <- read_csv("data/behavior/srm/other_liked.csv")
conversation_quality <- read_csv("data/behavior/srm/conversation_quality.csv")
video_conf_quality <- read_csv("data/behavior/srm/video_conf_quality.csv")


# Run SRM GLMM for each dataset
run_srm_glmm(liked, "Liked (SRM Relationship)")
run_srm_glmm(other_liked, "Other Liked Me (SRM Relationship)")
run_srm_glmm(conversation_quality, "Conversation Quality (SRM Relationship)")
run_srm_glmm(video_conf_quality, "Video Conference Quality (SRM Relationship)")

```
```{r}
#åˆå¹¶æ•°æ®
# ç­›é€‰ä¸»è¡¨ä¸­ question_content ä¸º liked çš„å­é›†

               # â† liked ä¸­å« relationship å€¼

library(dplyr)
library(readr)

# 1. è¯»å–æ•°æ®
all_data_df <- read.csv("data/behavior/all_data_df.csv")     # â† æ›¿æ¢ä¸ºä½ çš„è·¯å¾„
liked <- read_csv("data/behavior/srm/liked.csv")                  # â† liked ä¸­å« relationship å€¼



# 2. é‡å‘½å liked å­è¡¨å­—æ®µä»¥åŒ¹é…ä¸»è¡¨
liked_clean <- liked %>%
  rename(
    sid = group.id,
    user_id = participant_nb,
    other_id = interacting_partner
  ) %>%
  mutate(
    sid = as.character(sid),
    user_id = as.character(user_id),
    other_id = as.character(other_id)
  )

# 3. ç¡®ä¿ä¸»è¡¨å­—æ®µç±»å‹ä¸€è‡´
all_data_df <- all_data_df %>%
  mutate(
    sid = as.character(sid),
    user_id = as.character(user_id),
    other_id = as.character(other_id)
  )

# 4. ä»…å¯¹ liked æ¡ç›®åˆå¹¶ relationship åˆ†æ•°
all_data_liked <- all_data_df %>%
  filter(question_content == "liked") %>%
  left_join(
    liked_clean[, c("sid", "user_id", "other_id", "relationship")],
    by = c("sid", "user_id", "other_id")
  )

# 5. é liked æ¡ç›®ä¿æŒåŸæ ·ï¼Œrelationship è®¾ä¸º NA
all_data_other <- all_data_df %>%
  filter(question_content != "liked") %>%
  mutate(relationship = NA)

# 6. åˆå¹¶ä¸ºå®Œæ•´è¡¨
all_data_srm <- bind_rows(all_data_other, all_data_liked)

# 7. ä¿å­˜ç»“æœä¸ºæ–°æ–‡ä»¶
write_csv(all_data_srm, "all_data_srm.csv")


```
```{r}
#åˆå¹¶relationship
#å¾ªç¯éå†è¯»å–æ‰€æœ‰é—®é¢˜çš„
library(dplyr)
library(readr)

# 1. è¯»å–ä¸»è¡¨
all_data_df <- read_csv("data/behavior/all_data_df.csv") %>%
  mutate(
    sid = as.character(sid),
    user_id = as.character(user_id),
    other_id = as.character(other_id)
  )

# 2. è®¾å®šå­è¡¨æ–‡ä»¶æ‰€åœ¨è·¯å¾„
srm_path <- "data/behavior/srm"
question_list <- c("liked", "other_liked", "conversation_quality", "video_conf_quality")

# 3. ç”¨äºå­˜å‚¨æ¯ä¸€ç±»åˆå¹¶åçš„æ•°æ®
merged_chunks <- list()

# 4. å¾ªç¯è¯»å–å¹¶åˆå¹¶
for (question in question_list) {
  
  file_path <- file.path(srm_path, paste0(question, ".csv"))
  
  if (file.exists(file_path)) {
    
    srm_df <- read_csv(file_path) %>%
      rename(
        sid = group.id,
        user_id = participant_nb,
        other_id = interacting_partner
      ) %>%
      mutate(
        sid = as.character(sid),
        user_id = as.character(user_id),
        other_id = as.character(other_id)
      )
    
    # ç­›é€‰ä¸»è¡¨ä¸­å¯¹åº” question çš„å­é›†å¹¶åˆå¹¶
    data_q <- all_data_df %>%
      filter(question_content == question) %>%
      left_join(
        srm_df[, c("sid", "user_id", "other_id", "relationship")],
        by = c("sid", "user_id", "other_id")
      )
    
    merged_chunks[[question]] <- data_q
    
  } else {
    message(paste("âš ï¸ æ–‡ä»¶æœªæ‰¾åˆ°:", file_path, "- å·²è·³è¿‡è¯¥é¡¹"))
    
    # æ— æ–‡ä»¶ä¹Ÿä¿ç•™æ•°æ®å¹¶å¡«å…¥ NA
    merged_chunks[[question]] <- all_data_df %>%
      filter(question_content == question) %>%
      mutate(relationship = NA)
  }
}

# 5. åˆå¹¶æ‰€æœ‰éƒ¨åˆ†
all_data_srm <- bind_rows(merged_chunks)

# 6. ä¿å­˜æœ€ç»ˆæ•°æ®
write_csv(all_data_srm, "all_data_srm.csv")

message("âœ… all_data_srm.csv å·²æˆåŠŸä¿å­˜ï¼")

```
```{r}
#å®šä¹‰function
# Load required libraries
library(lme4)
library(ggplot2)

# Function to run GLMM for each SRM dataset
run_srm_glmm <- function(data, title) {
  # Ensure factors are properly set
  data$participant_condition <- as.factor(data$participant_condition)
  data$other_condition <- as.factor(data$other_condition)

  # Run the GLMM
  glmm_model <- lmer(relationship ~ participant_condition * other_condition + 
                      (1 | participant_nb) + (1 | interacting_partner), 
                      data = data)
  
  # Print summary
  print(summary(glmm_model))
  
  # Plot results
  ggplot(data, aes(x = participant_condition, y = relationship, color = other_condition)) +
    geom_point(alpha = 0.3, position = position_jitter(width = 0.2)) +
    stat_summary(fun = mean, geom = "point", size = 4, position = position_dodge(0.2)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(0.2)) +
    labs(title = title, x = "Participant Condition", y = "Relationship Rating (SRM)") +
    scale_color_manual(values = c("red", "blue")) +
    theme_minimal()
}


# Load datasets
liked <- read_csv("data/behavior/srm/liked.csv")
other_liked <- read_csv("data/behavior/srm/other_liked.csv")
conversation_quality <- read_csv("data/behavior/srm/conversation_quality.csv")
video_conf_quality <- read_csv("data/behavior/srm/video_conf_quality.csv")


# Run SRM GLMM for each dataset
run_srm_glmm(liked, "Liked (SRM Relationship)")
run_srm_glmm(other_liked, "Other Liked Me (SRM Relationship)")
run_srm_glmm(conversation_quality, "Conversation Quality (SRM Relationship)")
run_srm_glmm(video_conf_quality, "Video Conference Quality (SRM Relationship)")
```



```{r}
#ç”¨è€å¸ˆçš„æ–¹æ³•
#é‡ç°å›¾è¡¨ ç”¨srmæ¨¡å‹

library(lme4)
library(ggplot2)

# Function to run GLMM for each SRM dataset
run_srm_glmm <- function(data, title) {
  # Ensure factors are properly set
  data$participant_condition <- as.factor(data$participant_condition)
  data$other_condition <- as.factor(data$other_condition)

  # Run the GLMM
  glmm_model <- lmer(relationship ~ participant_condition * other_condition + 
                      (1 | participant_nb) + (1 | interacting_partner), 
                      data = data)
  
  # Print summary
  print(summary(glmm_model))
  
  # Plot results
  ggplot(data, aes(x = participant_condition, y = relationship, color = other_condition)) +
    geom_point(alpha = 0.3, position = position_jitter(width = 0.2)) +
    stat_summary(fun = mean, geom = "point", size = 4, position = position_dodge(0.2)) +
    stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, position = position_dodge(0.2)) +
    labs(title = title, x = "Participant Condition", y = "Relationship Rating (SRM)") +
    scale_color_manual(values = c("red", "blue")) +
    theme_minimal()
}



liked <- read_csv("all_data_srm.csv") %>%


# Run SRM GLMM for each dataset
run_srm_glmm(liked, "Liked (SRM Relationship)")

```

```{r}
#2ç”¨è‡ªå·±çš„æ–¹æ³•  relationship
#é‡ç°å›¾è¡¨ ç”¨srmæ¨¡å‹

# 1. åŠ è½½åŒ…
library(tidyverse)
library(dplyr)
library(TripleR)
library(lme4)
library(lmerTest)
library(ggplot2)

# 2. å‡è®¾æ•°æ®å·²è¯»å…¥ä¸º df
df <- read_csv("all_data_srm_unique.csv")



# ä¿®æ­£ç¼–ç ï¼ˆS = increase smile, U = decrease smileï¼‰
df <- df %>%
  mutate(
    participant_condition = recode(participant_condition, "S" = "increase", "U" = "decrease"),
    other_condition = recode(other_condition, "S" = "increase", "U" = "decrease")
  )

# æ˜ å°„æ ‡ç­¾
df$question_label <- recode(df$question_content,
  "liked" = "A. Liked",
  "other_liked" = "B. Other liked me",
  "conversation_quality" = "C. Conversation quality",
  "video_conf_quality" = "D. Video conference quality"
)

# è®¾ç½®å› å­é¡ºåºï¼ˆä¿è¯å›¾è¡¨æ’åºå’Œé…è‰²ä¸€è‡´ï¼‰
df$participant_condition <- factor(df$participant_condition, levels = c("increase", "decrease"))
df$other_condition <- factor(df$other_condition, levels = c("increase", "decrease"))
df$question_label <- factor(df$question_label,
  levels = c("A. Liked", "B. Other liked me", "C. Conversation quality", "D. Video conference quality"))

# ç»˜å›¾
g <- ggplot(df, aes(x = participant_condition, y = measure.p, color = other_condition)) +
  geom_jitter(width = 0.15, alpha = 0.2, size = 1.2) +  # æ•£ç‚¹å›¾å±‚
  stat_summary(fun = mean, geom = "point", size = 3,
               position = position_dodge(width = 0.4)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2,
               position = position_dodge(width = 0.4)) +
  stat_summary(fun = mean, geom = "line",
               position = position_dodge(width = 0.4), aes(group = other_condition), size = 0.8) +
  scale_color_manual(values = c("increase" = "red", "decrease" = "blue"),
                     name = "Other condition",
                     labels = c("increase smile", "decrease smile")) +
  facet_wrap(~question_label, nrow = 1) +
  labs(
    x = "Participant condition",
    y = "Participant Rating\n(relationship value in the SRM)",
    title = "Figure 6. Psychological analysis"
  ) +
  theme_minimal(base_size = 12)

# å±•ç¤ºå›¾
print(g)

# å¯é€‰ï¼šä¿å­˜ä¸ºé«˜åˆ†è¾¨å›¾åƒ
ggsave("Figure6_final.png", g, width = 13, height = 5, dpi = 300)
```



```{r}
#relationship SRM  è®¡ç®—å¾—åˆ°relationship valueã€measure.pã€measure.tå¹¶å­˜è¡¨
cat("\f")
rm(list=ls())

# Init
graphics.off()

#install.packages("ez")
#("phia")
#install.packages("effsize")
#install.packages("srm")
#install.packages("TripleR")
library("MASS")
library(ez)
library(afex)
library(phia)
library(doBy)
library(effsize)
library(lmerTest);
library(dplyr);
library(srm);
library(ggplot2)
library(TripleR)
library(tidyverse)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))


#Import data
file_name = "all_data_srm.csv"

#read data
data = read.table(file_name, header=TRUE,sep=',')
head(data)

#defining outcomes
measure			          <-as.numeric(data$measure)

#defining predictors (categorical)
participant_condition 	<- as.factor(data$participant_condition)
participant_condition   <- relevel(participant_condition, "S")
other_condition 		    <- as.factor(data$other_condition)
other_condition         <- relevel(other_condition, "S")
participant_nb			    <- as.factor(data$user_id)
interacting_partner			<- as.factor(data$other_id)
question_content		    <- as.factor(data$question_content)
group_id		            <- as.factor(data$sid)

#create new dataframe
all_data=data.frame( measure, participant_condition , interacting_partner, other_condition, participant_nb, question_content, group_id )

## -------------------------------------- ##
## -------------------------------------- ##
## GLMM Analysis ------------------------ ##
## -------------------------------------- ##
## -------------------------------------- ##

# Choose the question you want to anlayse
#question = "conversation_quality"
#question = "liked"
#question = "other_liked"
#question = "video_conf_quality"

clean_data <- all_data[all_data$question_content == question,]
head(clean_data)


#Social relation Model
RR.style("perception")

#Round Robin
RR1 <- RR(measure ~ participant_nb * interacting_partner | group_id, data = clean_data, na.rm = TRUE)
RR1


#Missing values
plot_missings(measure ~ participant_nb * interacting_partner | group_id, data = clean_data, show.ids = FALSE)

#Variance covariance
plot(RR1)


RR1$effects #measure perceiver and target
RR1$effectsRel

result_file = paste("data/behavior/srm/",question,".csv", sep="")
#write.csv(RR1$effectsRel, result_file) #Relationships

# ä¿å­˜ perceiver & target effects
result_file_effects <- paste("data/behavior/srm/", question, "_effects.csv", sep = "")
#write.csv(RR1$effects, result_file_effects, row.names = FALSE)

df = data(likingLong)


str(likingLong)
```



```{r}
#éå†å¤„ç†åˆå¹¶æ•°æ®measure.på’Œmeasure.t  æ¡ä»¶ sid = group.id, user_id = id
library(dplyr)
library(readr)



# 1. è¯»å–ä¸»è¡¨
all_data_df <- read_csv("all_data_srm.csv") %>%
  mutate(
    sid = as.character(sid),
    user_id=as.character(user_id)  )

# 2. è®¾å®šå­è¡¨æ–‡ä»¶æ‰€åœ¨è·¯å¾„
srm_path <- "data/behavior/srm"
question_list <- c("liked", "other_liked", "conversation_quality", "video_conf_quality")

# 3. ç”¨äºå­˜å‚¨æ¯ä¸€ç±»åˆå¹¶åçš„æ•°æ®
merged_chunks <- list()

# 4. å¾ªç¯è¯»å–å¹¶åˆå¹¶
for (question in question_list) {
  
  file_path <- file.path(srm_path, paste0(question, "_effects.csv"))
  
  if (file.exists(file_path)) {
    
    srm_df <- read_csv(file_path) %>%
      rename(
        sid = group.id,
        user_id = id
      ) %>%
      mutate(
        sid = as.character(sid),
        user_id = as.character(user_id)
      )
    
    # ç­›é€‰ä¸»è¡¨ä¸­å¯¹åº” question çš„å­é›†å¹¶åˆå¹¶
    data_q <- all_data_df %>%
      filter(question_content == question) %>%
      left_join(
        srm_df[, c("sid", "user_id", "measure.p", "measure.t")],
        by = c("sid", "user_id")
      )
    
    merged_chunks[[question]] <- data_q
    
  } else {
    message(paste("âš ï¸ æ–‡ä»¶æœªæ‰¾åˆ°:", file_path, "- å·²è·³è¿‡è¯¥é¡¹"))
    
    # æ— æ–‡ä»¶ä¹Ÿä¿ç•™æ•°æ®å¹¶å¡«å…¥ NA
    merged_chunks[[question]] <- all_data_df %>%
      filter(question_content == question) %>%
      mutate(relationship = NA)
  }
}

# 5. åˆå¹¶æ‰€æœ‰éƒ¨åˆ†
all_data_srm <- bind_rows(merged_chunks)

# 6. ä¿å­˜æœ€ç»ˆæ•°æ®
write_csv(all_data_srm, "all_data_srm_all.csv")
message("ğŸ‰ æ‰€æœ‰å¯ç”¨æ•ˆåº”å·²æˆåŠŸåˆå¹¶åˆ° all_data_srm_all.csv")




```

```{r}
#å»é‡
library(dplyr)
library(readr)

# è¯»å–æ•°æ®
df <- read_csv("all_data_srm_all.csv")

# æŒ‰ sid å’Œ user_id åˆ†ç»„ï¼Œä¿ç•™ç¬¬ä¸€æ¡è®°å½•ï¼ˆå›  perceiver/target_effect ç›¸åŒï¼‰
df_unique <- df %>%
  group_by(sid, user_id , question_content) %>%
  slice(1) %>%
  ungroup()

# ä¿å­˜å»é‡ç»“æœï¼ˆå¯é€‰ï¼‰
write_csv(df_unique, "all_data_srm_unique.csv")

message("âœ… å·²å®ŒæˆæŒ‰ sid + user_id å»é‡å¹¶ä¿ç•™å”¯ä¸€è¡Œã€‚")

```


```{r}
#ç”»å›¾
# åŠ è½½å¿…è¦åŒ…
library(ggplot2)
library(dplyr)

# è¯»å–æ•°æ®ï¼ˆå‡è®¾ä½ å·²ç»ç”¨ read.csv() è¯»å…¥ä¸º dfï¼‰
df <- read.csv("all_data_srm_unique.csv")


ggplot(df, aes(x = question_content, y = measure.t)) +
  geom_boxplot(fill = "lightblue", alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.4, color = "black") +
  theme_minimal() +
  labs(title = "measure.p by Question Content",
       x = "Question Content",
       y = "pe")

```


```{r}
#å°æç´å›¾
# åŠ è½½å¿…è¦çš„åŒ…
library(ggplot2)

# è¯»å–æ•°æ®ï¼ˆå‡è®¾ä½ å·²å°†æ•°æ®è¯»å…¥ä¸º dfï¼‰
df <- read.csv("all_data_srm_unique.csv")

# ç»˜åˆ¶ç®±çº¿å›¾
df %>% 
  drop_na(question_content) %>% 
  mutate(question_content = factor(question_content, 
                         levels = c("liked", "other_liked","conversation_quality","video_conf_quality"))) %>% 
  ggplot(aes(y = measure.p, x = question_content, fill = question_content)) +
  geom_boxplot() + 
  scale_y_continuous(name = "Interest score (1-7)", 
                     breaks = c(1:7)) + 
  scale_fill_viridis_d(option = "E", 
                       alpha = 0.6) + 
  guides(fill = "none")


```

```{r}
#æŸ±çŠ¶å›¾

# è¯»å–æ•°æ®ï¼ˆå‡è®¾ä½ å·²å°†æ•°æ®è¯»å…¥ä¸º dfï¼‰
df <- read.csv("all_data_srm_unique.csv")
# åŠ è½½å¿…è¦åŒ…
library(ggplot2)
library(dplyr)



# å‡è®¾ä½ çš„æ•°æ®æ¡†åä¸º df
# 1. è®¡ç®—æ¯ä¸ª question_content çš„å¹³å‡å€¼
mean_df <- df %>%
  group_by(question_content) %>%
  summarise(mean_measure_p = mean(measure.t, na.rm = TRUE))

View(mean_df)

ggplot(mean_df, aes(x = question_content, y = mean_measure_p)) +
  geom_col(fill = "skyblue") +
  geom_text(aes(label = signif(mean_measure_p, 3)), vjust = -0.5) +
  theme_minimal() +
  labs(title = "Mean of measure.p by Question Content",
       x = "Question Content",
       y = "Mean of measure.p") +
  coord_cartesian(ylim = c(-0.01, 0.01)) +  # æ‰‹åŠ¨è®¾ç½®yè½´èŒƒå›´
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```


```{r}
#correlation  é‡ç°åŸå§‹æ•°æ®å®éªŒ 

# 1. åŠ è½½åŒ…
library(tidyverse)
library(dplyr)
library(TripleR)
library(lme4)
library(lmerTest)
library(ggplot2)
library(correlation)

# 2. å‡è®¾æ•°æ®å·²è¯»å…¥ä¸º df
df <- read_csv("../Dissertation/all_data_df.csv")


# ä¿®æ­£ç¼–ç ï¼ˆS = decrease smile, U = increase smileï¼‰
df <- df %>%
  mutate(
    question1 = recode(align_condition, "S" = "aligned", "U" = "misaligned"),
    other_condition = recode(other_condition, "S" = "decrease", "U" = "increase")
  )

# æ˜ å°„æ ‡ç­¾
df$question_label <- recode(df$question_content,
  "liked" = "A. Liked",
  "other_liked" = "B. Other liked me",
 
)

# è®¾ç½®å› å­é¡ºåºï¼ˆä¿è¯å›¾è¡¨æ’åºå’Œé…è‰²ä¸€è‡´ï¼‰
df$question1 <- factor(df$question1, levels = c("increase", "decrease"))
df$other_condition <- factor(df$other_condition, levels = c("increase", "decrease"))
df$question_label <- factor(df$question_label,
  levels = c("A. Liked", "B. Other liked me", "C. Conversation quality", "D. Video conference quality"))

# ç»˜å›¾
g <- ggplot(df, aes(x = question1, y = measure, color = other_condition)) +
  geom_jitter(width = 0.15, alpha = 0.2, size = 1.2) +  # æ•£ç‚¹å›¾å±‚
  stat_summary(fun = mean, geom = "point", size = 3,
               position = position_dodge(width = 0.4)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2,
               position = position_dodge(width = 0.4)) +
  stat_summary(fun = mean, geom = "line",
               position = position_dodge(width = 0.4), aes(group = other_condition), size = 0.8) +
  scale_color_manual(values = c("increase" = "red", "decrease" = "blue"),
                     name = "Other condition",
                     labels = c("increase smile", "decrease smile")) +
  facet_wrap(~question_label, nrow = 1) +
  labs(
    x = "Participant condition",
    y = "Participant Rating\n(relationship value in the SRM)",
    title = "Figure 6. Psychological analysis"
  ) +
  theme_minimal(base_size = 12)

# å±•ç¤ºå›¾
print(g)
```

```{r}
# correlation  between measure.p and measure.t

#install.packages("correlation")  # å¦‚æœè¿˜æ²¡è£…

#æŸ¥çœ‹æ€»çš„correlation
library(correlation)

df <- read_csv("all_data_srm_all.csv")
df %>% 
  ggplot(aes(x = measure.p, y = measure.t)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "measure.p", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " measure.t", 
                     breaks = c(1:6))

correlation(data = df, 
            select = "measure.p", 
            select2 = "measure.t",  
            method = "spearman",
            alternative = "two.sided")


#æŒ‰ç…§é—®é¢˜åˆ†ç»„
library(purrr)

# 1. æŒ‰ question_content åˆ†ç»„
grouped <- df %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., measure.p, measure.t), method = "spearman"))

# 3. åŠ ä¸Šåˆ†ç»„åå¹¶ç»„åˆæˆä¸€ä¸ªè¡¨
names(cor_list) <- sapply(grouped, function(x) unique(x$question_content))
cor_combined <- bind_rows(cor_list, .id = "question_content")

# æŸ¥çœ‹
print(cor_combined)



#è¯»å–åŸå§‹æ•°æ® åˆ†æç›¸å…³æ€§

originaldata <- read_csv("data/behavior/srm/liked_effects.csv")


correlation(data = originaldata, 
            select = "measure.p", 
            select2 = "measure.t",  
            method = "spearman",
            alternative = "two.sided")

```

```{r}
# çœ‹relationshipçš„åˆ†å¸ƒ
#ç”»å›¾
# åŠ è½½å¿…è¦åŒ…
library(ggplot2)
library(dplyr)

# è¯»å–æ•°æ®ï¼ˆå‡è®¾ä½ å·²ç»ç”¨ read.csv() è¯»å…¥ä¸º dfï¼‰
df <- read.csv("all_data_srm_all.csv")


ggplot(df, aes(x = question_content, y = relationship)) +
  geom_boxplot(fill = "lightblue", alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.4, color = "black") +
  theme_minimal() +
  labs(title = "relationship by Question Content",
       x = "Question Content",
       y = "relationship")


```

```{r}
#calculate correlation
library(dplyr)
library(tidyr)

# å‡è®¾ä½ çš„æ•°æ®å« dfï¼Œä¸”å·²åŠ è½½
df <- read.csv("all_data_srm_all.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

# åˆ›å»ºæ ‡å‡† dyadï¼ˆåŒå‘ç»Ÿä¸€ï¼‰
df <- df %>%
  mutate(dyad_std = ifelse(as.character(user_id) < as.character(other_id),
                           paste(user_id, other_id, sep = "_"),
                           paste(other_id, user_id, sep = "_")))

# åªä¿ç•™ measureï¼ˆæˆ– relationshipï¼‰ä¸¤ä¸ªæ–¹å‘éƒ½å­˜åœ¨çš„æ•°æ®
df_wide <- df %>%
  select(dyad_std, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = user_id, values_from = measure)  # å®½æ ¼å¼è½¬åŒ–

# æˆ–è€…å¦ä¸€ç§åšæ³•ï¼šé…å¯¹å¹¶åˆå¹¶æˆ Aâ†’B å’Œ Bâ†’A ä¸¤è¡Œæ‹¼ä¸€è¡Œ
df_paired <- df %>%
  select(dyad_std, question_content, user_id, other_id, measure) %>%
  group_by(dyad_std, question_content) %>%
  filter(n() == 2) %>%
  arrange(dyad_std, question_content, user_id) %>%
  mutate(pair_id = paste0(dyad_std, "_", question_content)) %>%
  summarise(
    rel1 = first(measure),
    rel2 = last(measure)
  )

# è®¡ç®—é…å¯¹ç›¸å…³æ€§ï¼ˆæ¯ç§ question_content ä¸€æ¬¡ï¼‰
cor_results <- df_paired %>%
  group_by(question_content) %>%
  summarise(
    correlation = cor(rel1, rel2, use = "complete.obs"),
    n = n()
  )

print(cor_results)

ggplot(df_paired, aes(x = rel1, y = rel2)) +
  geom_point(alpha = 0.6, color = "orange") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Reciprocal Relationship Scores: Aâ†’B vs Bâ†’A",
       x = "A to B (relationship score)",
       y = "B to A (relationship score)") +
  theme_minimal()


library(ggplot2)

ggplot(df_paired, aes(x = rel1, y = rel2)) +
  geom_point(alpha = 0.6, color = "orange") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  facet_wrap(~ question_content) +  # æŒ‰é—®é¢˜ç±»å‹åˆ†é¢
  labs(
    title = "Reciprocal Relationship Scores by Question Content",
    x = "A to B (relationship score)",
    y = "B to A (relationship score)"
  ) +
  theme_minimal()

#install.packages("ggpubr")  # åªéœ€ä¸€æ¬¡
library(ggpubr)


ggplot(df_paired, aes(x = rel1, y = rel2)) +
  geom_point(alpha = 0.6, color = "orange") +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  stat_cor(method = "spearman", label.x = -2.5, label.y = 2.5) +  # æ·»åŠ ç›¸å…³ç³»æ•°
  facet_wrap(~ question_content) +
  labs(
    title = "Reciprocal Relationship (Spearman r) by Question Content",
    x = "A to B (relationship score)",
    y = "B to A (relationship score)"
  ) +
  theme_minimal()

library(correlation)
df_paired %>% 
  ggplot(aes(x = measure.p, y = measure.t)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "measure.p", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " measure.t", 
                     breaks = c(1:6))

correlation(data = df, 
            select = "measure.p", 
            select2 = "measure.t",  
            method = "spearman",
            alternative = "two.sided")


```

```{r}
#correlation  åŒä¸€ç»„AtoB å’ŒBto A  åŒä¸€ä¸ªé—®é¢˜çš„correlation
#calculate correlation
library(dplyr)
library(tidyr)
library(tidyverse)
library(dplyr)
library(TripleR)
library(lme4)
library(lmerTest)
library(ggplot2)
library(correlation)

# å‡è®¾ä½ çš„æ•°æ®å« dfï¼Œä¸”å·²åŠ è½½
df <- read.csv("all_data_srm_all.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

# åˆ›å»ºæ ‡å‡† dyadï¼ˆåŒå‘ç»Ÿä¸€ï¼‰
df <- df %>%
  mutate(dyad_std = ifelse(as.character(user_id) < as.character(other_id),
                           paste(user_id, other_id, sep = "_"),
                           paste(other_id, user_id, sep = "_")))

# åªä¿ç•™ measureï¼ˆæˆ– relationshipï¼‰ä¸¤ä¸ªæ–¹å‘éƒ½å­˜åœ¨çš„æ•°æ®
df_wide <- df %>%
  select(dyad_std, user_id, other_id, question_content, measure,relationship) %>%
  pivot_wider(names_from = user_id, values_from = measure)  # å®½æ ¼å¼è½¬åŒ–

# æˆ–è€…å¦ä¸€ç§åšæ³•ï¼šé…å¯¹å¹¶åˆå¹¶æˆ Aâ†’B å’Œ Bâ†’A ä¸¤è¡Œæ‹¼ä¸€è¡Œ
df_paired <- df %>%
  select(dyad_std, question_content, user_id, other_id, measure,relationship) %>%
  group_by(dyad_std, question_content) %>%
  filter(n() == 2) %>%
  arrange(dyad_std, question_content, user_id) %>%
  mutate(pair_id = paste0(dyad_std, "_", question_content)) %>%
  summarise(question_content,
    rel1 = first(measure),
    rel2 = last(measure),
    relationship1=first(relationship),
    relationship2=last(relationship)
  )

df_paired %>% 
  ggplot(aes(x = rel1, y = rel2)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "rel1", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " rel2", 
                     breaks = c(1:6))

#å­˜è¡¨
#write.csv(df_paired, "data/behavior/srm/correlation.csv", row.names = FALSE)



correlation(data = df_paired, 
            select = "rel1", 
            select2 = "rel2",  
            method = "spearman",
            alternative = "two.sided")


library(correlation)

# åªå–ä½ è¦åˆ†æçš„åˆ—ï¼Œæ„å»ºä¸€ä¸ªç®€æ´æ•°æ®æ¡†
rel_data  <- df_paired %>% select(rel1, rel2)

# ä½¿ç”¨ correlation() æ˜ç¡®è¯´æ˜åˆ—åï¼Œä¸è®©å®ƒè‡ªåŠ¨åˆ†ç»„
cor_result <- correlation(
  data = rel_data,
  method = "spearman"
)
print(cor_result)

library(purrr)

# 1. æŒ‰ question_content åˆ†ç»„
grouped <- df_paired %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., rel1, rel2), method = "spearman"))

# 3. åŠ ä¸Šåˆ†ç»„åå¹¶ç»„åˆæˆä¸€ä¸ªè¡¨
names(cor_list) <- sapply(grouped, function(x) unique(x$question_content))
cor_combined <- bind_rows(cor_list, .id = "question_content")

# æŸ¥çœ‹
print(cor_combined)


# æŸ¥çœ‹ç»“æœ
print(cor_result)


# è®¡ç®—é…å¯¹ç›¸å…³æ€§ï¼ˆæ¯ç§ question_content ä¸€æ¬¡ï¼‰
cor_results <- df_paired %>%
  group_by(question_content) %>%
  summarise(
    correlation = cor(rel1, rel2, use = "complete.obs"),
    n = n()
  )

print(cor_results)


```

```{r}
#è®¡ç®—å…³ç³» åŒä¸€ç»„AtoB å’ŒBto A  åŒä¸€ä¸ªdyadä¹‹é—´å¯¹åŒä¸€ä¸ªé—®é¢˜çš„è¯„åˆ†ä¹‹é—´çš„è”ç³»
library(ggplot2)
library(correlation)
library(dplyr)

df <- read.csv("data/behavior/srm/correlation.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

df %>% 
  ggplot(aes(x = rel1, y = rel2)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "rel1", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " rel2", 
                     breaks = c(1:6))

correlation(data = df, 
            select = "rel1", 
            select2 = "rel2",  
            method = "spearman",
            alternative = "two.sided")


library(purrr)

#å»é‡
df_unique <- df %>%
  distinct(dyad_std, question_content, .keep_all = TRUE)

# 1. æŒ‰ question_content åˆ†ç»„



grouped <- df_unique %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., rel1, rel2), method = "spearman"))

# 3. åŠ ä¸Šåˆ†ç»„åå¹¶ç»„åˆæˆä¸€ä¸ªè¡¨
names(cor_list) <- sapply(grouped, function(x) unique(x$question_content))
cor_combined <- bind_rows(cor_list, .id = "question_content")

# æŸ¥çœ‹
print(cor_combined)

df_liked <- df %>% 
  filter(question_content == "liked")

df_liked %>% 
  ggplot(aes(x = rel1, y = rel2)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "rel1", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " rel2", 
                     breaks = c(1:6))

correlation(data = df_liked, 
            select = "rel1", 
            select2 = "rel2",  
            method = "spearman",
            alternative = "two.sided")

```

```{r}
#è®¡ç®—likedå’Œother_likedä¹‹é—´çš„correlation  --æ•°æ®æ¸…æ´—
library(dplyr)
library(tidyr)

library(correlation)

df <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

# 1. ç­›é€‰ liked å’Œ other_liked
df_filtered <- df %>%
  filter(question_content %in% c("liked", "other_liked"))

# 2. æŒ‰ dyad + å‚ä¸è€…ä¿¡æ¯åˆ†ç»„ï¼Œå¹¶å®½æ ¼å¼è½¬åŒ–
df_wide <- df_filtered %>%
  group_by(dyad, user_id, other_id, participant_condition, other_condition) %>%
  filter(n() == 2) %>%  # ç¡®ä¿ liked å’Œ other_liked éƒ½å­˜åœ¨
  select(dyad, user_id, other_id, participant_condition, other_condition,
         question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure) %>%
  drop_na(liked, other_liked)  # é˜²æ­¢æœ‰ç¼ºå¤±

#å­˜è¡¨
write.csv(df_wide, "data/behavior/srm/correlation_liked_otherliked.csv", row.names = FALSE)




```

```{r}
#correlation  between liked and other_liked
library(ggplot2)
library(correlation)
library(dplyr)

df <- read.csv("data/behavior/srm/correlation_liked_otherliked.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„


df %>% 
  ggplot(aes(x = liked, y = other_liked)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "liked", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " other_liked", 
                     breaks = c(1:6))

correlation(data = df, 
            select = "liked", 
            select2 = "other_liked",  
            method = "spearman",
            alternative = "two.sided")


library(pwr)

# Spearman ç›¸å…³ç³»æ•°
rho <- 0.87

# è®¡ç®—æœ€å°æ ·æœ¬é‡
result <- pwr.r.test(r = rho,
                     sig.level = 0.05,
                     power = 0.80,
                     alternative = "two.sided")

# è¾“å‡ºç»“æœ
print(result)


```

```{r}
#è®¡ç®—conditionç›¸åŒä¸‹çš„åŒæ ·é—®é¢˜A2B å’ŒB2Açš„ç›¸å…³æ€§--æ•°æ®æ¸…æ´—éƒ¨åˆ†


library(dplyr)
library(tidyr)

# å‡è®¾ä½ çš„åŸå§‹æ•°æ®å« df
df <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

# ç¬¬ä¸€æ­¥ï¼šä¸ºæ¯ç»„æ„å»ºå”¯ä¸€æ ‡è¯†ï¼ˆæ–¹ä¾¿ group_byï¼‰
# åˆ›å»ºæ ‡å‡† dyadï¼ˆåŒå‘ç»Ÿä¸€ï¼‰
df <- df %>%
  mutate(dyad_std = ifelse(as.character(user_id) < as.character(other_id),
                           paste(user_id, other_id, sep = "_"),
                           paste(other_id, user_id, sep = "_")))

# åªä¿ç•™ measureï¼ˆæˆ– relationshipï¼‰ä¸¤ä¸ªæ–¹å‘éƒ½å­˜åœ¨çš„æ•°æ®
df_wide <- df %>%
  select(dyad_std, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = user_id, values_from = measure)  # å®½æ ¼å¼è½¬åŒ–

# æˆ–è€…å¦ä¸€ç§åšæ³•ï¼šé…å¯¹å¹¶åˆå¹¶æˆ Aâ†’B å’Œ Bâ†’A ä¸¤è¡Œæ‹¼ä¸€è¡Œ
df_paired <- df %>%
  select(dyad_std, question_content, user_id, other_id, measure, participant_condition,other_condition) %>%
  group_by(dyad_std, question_content,participant_condition,other_condition) %>%
  filter(n() == 2) %>%
  arrange(dyad_std, question_content, user_id) %>%
  mutate(pair_id = paste0(dyad_std, "_", question_content)) %>%
  summarise(question_content,
    rel1 = first(measure),
    rel2 = last(measure)
  )

#å­˜è¡¨
write.csv(df_paired, "data/behavior/srm/correlation_samecondition.csv", row.names = FALSE)

```

```{r}
#è®¡ç®—conditionç›¸åŒä¸‹çš„åŒæ ·é—®é¢˜A2B å’ŒB2Açš„ç›¸å…³

library(purrr)
library(dplyr)

df <- read.csv("data/behavior/srm/correlation_samecondition.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

#å»é‡
df_unique <- df %>%
  distinct(dyad_std, question_content, .keep_all = TRUE)

# 1. æŒ‰ question_content åˆ†ç»„



grouped <- df %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., rel1, rel2), method = "spearman"))

print(cor_list)
```


```{r}
#åˆ†æ 1ï¼šown_other_liked vs. partner_likedï¼ˆæˆ‘èƒ½å¦é¢„æµ‹åˆ«äººå–œæ¬¢æˆ‘ï¼‰

#åˆ†æ 2ï¼špartner_other_liked vs. own_likedï¼ˆåˆ«äººèƒ½å¦é¢„æµ‹æˆ‘å–œæ¬¢ä»–ï¼‰

# è¯»å–æ•°æ®
data <- read.csv("data/behavior/all_data_df.csv")  # è¯·æ›¿æ¢æˆä½ çš„ CSV è·¯å¾„

# ä»…ä¿ç•™ liked å’Œ other_liked ä¸¤ç±»é—®é¢˜
filtered_data <- subset(data, question_content %in% c("liked", "other_liked"))

# å°†æ•°æ® pivot_widerï¼Œæ–¹ä¾¿åç»­åŒ¹é…
library(tidyr)
library(dplyr)

# æŠŠ question_content çš„å€¼å˜æˆåˆ—
wide_data <- filtered_data %>%
  select(dyad, user_id, question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure)

# å°† dyad å†…çš„ user_id å’Œ other_id åŒ¹é…èµ·æ¥
# ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŠŠ dyad å†…çš„ä¸¤ä¸ªäººçš„æ•°æ®æ‹¼åœ¨ä¸€è¡Œ

# åˆ†åˆ«æå–ä¸¤ä¸ªäººçš„æ•°æ®
person1 <- wide_data %>%
  group_by(dyad) %>%
  slice(1) %>%
  rename(user1 = user_id, user1_liked = liked, user1_other_liked = other_liked)

person2 <- wide_data %>%
  group_by(dyad) %>%
  slice(2) %>%
  rename(user2 = user_id, user2_liked = liked, user2_other_liked = other_liked)

# åˆå¹¶ä¸º dyad å±‚çº§
dyad_data <- left_join(person1, person2, by = "dyad")

# åˆ†æ 1ï¼šæˆ‘é¢„æµ‹åˆ«äººæ˜¯å¦å–œæ¬¢æˆ‘
cor_test1 <- cor.test(dyad_data$user1_other_liked, dyad_data$user2_liked)  # user1 çŒœæµ‹ user2 å®é™…
cor_test2 <- cor.test(dyad_data$user2_other_liked, dyad_data$user1_liked)  # user2 çŒœæµ‹ user1 å®é™…

# åˆ†æ 2ï¼šåˆ«äººé¢„æµ‹æˆ‘æ˜¯å¦å–œæ¬¢ä»–ä»¬
cor_test3 <- cor.test(dyad_data$user2_other_liked, dyad_data$user2_liked)  # user2 çŒœæµ‹ user1 å®é™…
cor_test4 <- cor.test(dyad_data$user1_other_liked, dyad_data$user1_liked)  # user1 çŒœæµ‹ user2 å®é™…

# æŸ¥çœ‹ç»“æœ
print(cor_test1)  # user1 çš„é¢„æµ‹å‡†ç¡®æ€§
print(cor_test2)  # user2 çš„é¢„æµ‹å‡†ç¡®æ€§

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä½ä¼°/é«˜ä¼°åå·®
mean_diff1 <- dyad_data$user1_other_liked - dyad_data$user2_liked
mean_diff2 <- dyad_data$user2_other_liked - dyad_data$user1_liked
t.test(mean_diff1)
t.test(mean_diff2)

```




```{r}
# èƒ½å¦é¢„æµ‹æœ€ç»ˆç‰ˆæœ¬  è¿™ä¸¤ä¸ªç›¸å…³æ€§åº”è¯¥æ˜¯ä¸€æ ·çš„å§ å› ä¸ºä»…ä»…æ˜¯äº¤æ¢çºµåæ ‡å’Œæ¨ªåæ ‡
library(tidyverse)

# è¯»å–æ•°æ®
data <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

# ç­›é€‰ liked å’Œ other_liked ä¸¤ç§é¢˜ç›®
filtered_data <- data %>%
  filter(question_content %in% c("liked", "other_liked"))

# å°†è‡ªå·±çš„ liked / other_liked åˆ†åˆ« pivot ä¸ºå®½æ ¼å¼
own_wide <- filtered_data %>%
  select(dyad, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure) %>%
  rename(own_liked = liked, own_other_liked = other_liked)


# partner çš„ liked å’Œ other_likedï¼Œäº¤æ¢ user_id å’Œ other_id
partner_wide <- filtered_data %>%
  select(dyad, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure) %>%
  rename(partner_liked = liked, partner_other_liked = other_liked) %>%
  rename(user_id_partner = user_id, other_id_partner = other_id)

# åˆå¹¶ï¼šæŒ‰ dyad å’Œ user_id / other_id åŒ¹é… partner æ•°æ®
merged_data <- own_wide %>%
  left_join(partner_wide,
            by = c("dyad" = "dyad", "user_id" = "other_id_partner", "other_id" = "user_id_partner"))

# æˆ‘æ˜¯å¦èƒ½é¢„æµ‹åˆ«äººå–œæ¬¢æˆ‘
cor1 <- cor.test(merged_data$own_other_liked, merged_data$partner_liked, use = "complete.obs")
print(cor1)

# åˆ«äººæ˜¯å¦èƒ½é¢„æµ‹æˆ‘å–œæ¬¢ä»–ä»¬
cor2 <- cor.test(merged_data$partner_other_liked, merged_data$own_liked, use = "complete.obs")
print(cor2)

cor.test(merged_data$partner_other_liked, merged_data$own_liked,
         method = "spearman", use = "complete.obs")

cor.test(merged_data$partner_liked, merged_data$own_other_liked,
         method = "spearman", use = "complete.obs")

write_csv(merged_data, "all_data_dyad_prediction.csv")


merged_data %>% 
  ggplot(aes(x = own_liked, y = partner_other_liked)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "own_liked", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " partner_other_liked", 
                     breaks = c(1:6))

library(correlation)

correlation(data = merged_data, 
            select = "own_liked", 
            select2 = "partner_other_liked",  
            method = "spearman",
            alternative = "two.sided")

correlation(data = merged_data, 
            select = "own_other_liked", 
            select2 = "partner_liked",  
            method = "spearman",
            alternative = "two.sided")
```


```{r}
#ç­›é€‰å‡ºéƒ½æ˜¯å¢å¼ºçŠ¶æ€ä¸‹çš„å¾®ç¬‘ æŸ¥çœ‹æ˜¯å¦å¯ä»¥é¢„æµ‹
# è¯»å–æ•°æ®
data <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

# ç­›é€‰ liked å’Œ other_liked ä¸¤ç§é¢˜ç›®
filtered_data <- data %>%
  filter(question_content %in% c("liked", "other_liked")) %>%
  filter(participant_condition == other_condition)

# å°†è‡ªå·±çš„ liked / other_liked åˆ†åˆ« pivot ä¸ºå®½æ ¼å¼
own_wide <- filtered_data %>%
  select(dyad, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure) %>%
  rename(own_liked = liked, own_other_liked = other_liked)


# partner çš„ liked å’Œ other_likedï¼Œäº¤æ¢ user_id å’Œ other_id
partner_wide <- filtered_data %>%
  select(dyad, user_id, other_id, question_content, measure) %>%
  pivot_wider(names_from = question_content, values_from = measure) %>%
  rename(partner_liked = liked, partner_other_liked = other_liked) %>%
  rename(user_id_partner = user_id, other_id_partner = other_id)

# åˆå¹¶ï¼šæŒ‰ dyad å’Œ user_id / other_id åŒ¹é… partner æ•°æ®
merged_data <- own_wide %>%
  left_join(partner_wide,
            by = c("dyad" = "dyad", "user_id" = "other_id_partner", "other_id" = "user_id_partner"))

# æˆ‘æ˜¯å¦èƒ½é¢„æµ‹åˆ«äººå–œæ¬¢æˆ‘
cor1 <- cor.test(merged_data$own_other_liked, merged_data$partner_liked, use = "complete.obs")
print(cor1)

# åˆ«äººæ˜¯å¦èƒ½é¢„æµ‹æˆ‘å–œæ¬¢ä»–ä»¬
cor2 <- cor.test(merged_data$partner_other_liked, merged_data$own_liked, use = "complete.obs")
print(cor2)

cor.test(merged_data$partner_other_liked, merged_data$own_liked,
         method = "spearman", use = "complete.obs")


merged_data %>% 
  ggplot(aes(x = own_liked, y = partner_other_liked)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "own_liked", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " partner_other_liked", 
                     breaks = c(1:6))

correlation(data = merged_data, 
            select = "own_liked", 
            select2 = "partner_other_liked",  
            method = "spearman",
            alternative = "two.sided")
```


```{r}
#æŸ¥çœ‹ä¸€å¯¹ä¹‹é—´çš„relationshipçš„ç›¸å…³æ€§  æ˜¯å¦æœ‰æ„ä¹‰ï¼Ÿæ“çºµè¿‡çš„ è¿™ä¸ªrelationshipæ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„
library(dplyr)
library(tidyr)

# è¯»å–æ•°æ®
df <- read.csv("your_file.csv")  # è¯·ä¿®æ”¹ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

# åˆ›å»ºä¸€ä¸ª key ç”¨äºå”¯ä¸€ç¡®å®š dyad å…³ç³» (user å¯¹ other) å’Œ (other å¯¹ user)
df <- df %>%
  mutate(pair = paste(pmin(user_id, other_id), pmax(user_id, other_id), sep = "_"))

# æŒ‰ sidã€dyadã€participantã€other_concã€question_cã€pair åˆ†ç»„ï¼Œæ•´ç†æˆ wide æ ¼å¼
df_wide <- df %>%
  select(sid, dyad, participant_condition = participant, other_condition = other_conc, question_content = question_c,
         user_id, other_id, relationship, pair) %>%
  pivot_wider(names_from = user_id, values_from = relationship, values_fn = list(relationship = mean))

# æˆ–è€…ç›´æ¥ inner_join æ–¹å¼é…å¯¹
# å°†åŸå§‹æ•°æ®å¤åˆ¶ä¸ºä¸¤ä»½ï¼Œä¸€ä»½æ˜¯ A -> Bï¼Œä¸€ä»½æ˜¯ B -> Aï¼Œè¿›è¡Œåˆå¹¶
df_a <- df %>%
  select(sid, dyad, participant_condition = participant, other_condition = other_conc, question_content = question_c,
         user_id_A = user_id, other_id_A = other_id, relationship_A = relationship)

df_b <- df %>%
  select(sid, dyad, participant_condition = participant, other_condition = other_conc, question_content = question_c,
         user_id_B = other_id, other_id_B = user_id, relationship_B = relationship)

# å†…è¿æ¥ï¼Œå°† A->B å’Œ B->A çš„æ•°æ®é…å¯¹
paired_df <- inner_join(df_a, df_b,
                        by = c("sid", "dyad", "participant_condition", "other_condition", "question_content",
                               "user_id_A" = "user_id_B", "other_id_A" = "other_id_B"))

# è®¡ç®—æ¯ç»„çš„ correlation
result <- paired_df %>%
  group_by(sid, dyad, participant_condition, other_condition, question_content) %>%
  summarise(correlation = cor(relationship_A, relationship_B, use = "complete.obs"),
            .groups = "drop")

# æŸ¥çœ‹ç»“æœ
print(result)


```


```{r}
#è®¡ç®—relationshipä¹‹é—´çš„correlation  --æ•°æ®æ¸…æ´—


# å‡è®¾ä½ çš„æ•°æ®å« dfï¼Œä¸”å·²åŠ è½½
df <- read.csv("all_data_srm_all.csv")  # æ›¿æ¢ä¸ºä½ çš„å®é™…è·¯å¾„

# åˆ›å»ºæ ‡å‡† dyadï¼ˆåŒå‘ç»Ÿä¸€ï¼‰
df <- df %>%
  mutate(dyad_std = ifelse(as.character(user_id) < as.character(other_id),
                           paste(user_id, other_id, sep = "_"),
                           paste(other_id, user_id, sep = "_")))

# åªä¿ç•™ measureï¼ˆæˆ– relationshipï¼‰ä¸¤ä¸ªæ–¹å‘éƒ½å­˜åœ¨çš„æ•°æ®
df_wide <- df %>%
  select(dyad_std, user_id, other_id, question_content, relationship) %>%
  pivot_wider(names_from = user_id, values_from = relationship)  # å®½æ ¼å¼è½¬åŒ–

# æˆ–è€…å¦ä¸€ç§åšæ³•ï¼šé…å¯¹å¹¶åˆå¹¶æˆ Aâ†’B å’Œ Bâ†’A ä¸¤è¡Œæ‹¼ä¸€è¡Œ
df_paired <- df %>%
  select(dyad_std, question_content, user_id, other_id, relationship) %>%
  group_by(dyad_std, question_content) %>%
  filter(n() == 2) %>%
  arrange(dyad_std, question_content, user_id) %>%
  mutate(pair_id = paste0(dyad_std, "_", question_content)) %>%
  summarise(
    relationship1 = first(relationship),
    relationship2 = last(relationship)
  )


#å­˜è¡¨
write.csv(df_paired, "data/behavior/srm/correlation_relationship.csv", row.names = FALSE)

```
```{r}
# correlation  between relationship

#install.packages("correlation")  # å¦‚æœè¿˜æ²¡è£…
library(correlation)

df <- read_csv("data/behavior/srm/correlation_relationship.csv")
df %>% 
  ggplot(aes(x = relationship1, y = relationship2)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "measure.p", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " measure.t", 
                     breaks = c(1:6))

correlation(data = df, 
            select = "relationship1", 
            select2 = "relationship2",  
            method = "spearman",
            alternative = "two.sided")


library(purrr)

# 1. æŒ‰ question_content åˆ†ç»„
grouped <- df %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., relationship1, relationship2), method = "spearman"))

# 3. åŠ ä¸Šåˆ†ç»„åå¹¶ç»„åˆæˆä¸€ä¸ªè¡¨
names(cor_list) <- sapply(grouped, function(x) unique(x$question_content))
cor_combined <- bind_rows(cor_list, .id = "question_content")

# æŸ¥çœ‹
print(cor_combined)


# æŸ¥çœ‹ç»“æœ
print(cor_result)



```


```{r}
#AVONA æ•°æ®å¤„ç†ä»¥åŠè§£æ
# è¯»å–æ•°æ®
data <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

# æ–°å¢åˆ— alignment
data$alignment <- ifelse(data$participant_condition == data$other_condition, 1, 0)
#å­˜è¡¨
write.csv(data, "data/behavior/all_data_df_judge.csv", row.names = FALSE)

data_judge <- read.csv("data/behavior/all_data_df_judge.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

# å®‰è£…å¿…è¦åŒ…ï¼ˆå¦‚æœªå®‰è£…è¯·å…ˆè¿è¡Œï¼‰
# install.packages(c("afex", "tidyverse"))

library(afex)
library(tidyverse)

# å‡è®¾æ‚¨å·²ç»è¯»å–æ•°æ®ä¸º data
# data <- read.csv("your_file.csv")

# å°† participant ID åˆ—å‘½åä¸º idï¼Œè¿™é‡Œæ˜¯ sid
# ç¡®ä¿ question_content å’Œ alignment éƒ½æ˜¯ factor
data_judge <- data_judge %>%
  mutate(
    alignment = factor(alignment, levels = c(0, 1), labels = c("NotAligned", "Aligned")),
    question_content = factor(question_content),
    sid = as.factor(sid)  # participant identifier
  )

# æ‰§è¡Œæ··åˆè®¾è®¡ ANOVA
anova_result <- aov_ez(
  id = "sid",                  # å—è¯•è€… ID
  dv = "measure",              # å› å˜é‡
  data = data,                 # æ•°æ®
  within = "question_content", # è¢«è¯•å†…å˜é‡
  between = "alignment"        # è¢«è¯•é—´å˜é‡
)

# æŸ¥çœ‹ç»“æœ
print(anova_result)

```

```{r}
#åˆ†ç»„ å¯¹mearurepå’Œmearure.t è®¡ç®—ANOVA å¹¶ä¿å­˜æ–°çš„è¡¨

# è¯»å–æ•°æ®
df <- read.csv("all_data_srm_unique.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„



library(dplyr)
library(tidyr)

# å‡è®¾ df æ˜¯ä½ çš„åŸå§‹æ•°æ®
df_long <- df %>%
  pivot_longer(
    cols = c(measure.p, measure.t),
    names_to = "condition",
    values_to = "value"
  ) %>%
  mutate(
    condition = recode(condition,
                       "measure.p" = "perceiver_value",
                       "measure.t" = "target_value")
  )

#å­˜è¡¨
write.csv(df_long, "all_data_srm_unique_group.csv", row.names = FALSE)

```


```{r}
# æ–¹å·® ç”¨ä¹¦ä¸Šçš„æ–¹å¼è®¡ç®—

#install.packages("rcompanion")
#install.packages("effectsize")
#install.packages("car")
#install.packages("broom")
#install.packages("emmeans")
#install.packages("performance")
#install.packages("afex")
#install.packages("ez")
library(rcompanion)
library(effectsize)
library(car)
library(broom)
library(broom)
library(emmeans)
library(tidyverse)
library(performance)
library(ez)
library(afex)
# specify as an object, so we only change it in one place
dodge_value  <- read.csv("all_data_srm_unique_group.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

dodge_value %>% 
  mutate(value = case_match(condition,
                           "measure.p" ~ "perceiver_value",
                           "measure.t" ~ "target_value")) %>% 
  ggplot(aes(y = value, x = question_content, fill = condition)) +
  geom_violin(alpha = 0.5) + 
  geom_boxplot(width = 0.2, 
               alpha = 0.7,
               fatten = NULL,
               position = position_dodge(dodge_value)) + 
  stat_summary(fun = "mean", 
               geom = "point",
               position = position_dodge(dodge_value)) +
  stat_summary(fun.data = "mean_cl_boot", 
               geom = "errorbar", 
               width = .1,
               position = position_dodge(dodge_value)) +
  scale_fill_viridis_d(option = "E") + 
  scale_y_continuous(name = "Interest score (1-7)", 
                     breaks = c(1:7)) + 
  theme_classic()


#GPTç»™çš„ä»£ç   å¯è§†åŒ–
library(dplyr)
library(ggplot2)
library(viridis)
position = position_dodge(width = 0.8)

dodge_value <- read.csv("all_data_srm_unique_group.csv")

dodge_value %>%
  ggplot(aes(y = value, x = question_content, fill = condition)) +
  geom_violin(alpha = 0.5, position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.2,
               alpha = 0.7,
               position = position_dodge(width = 0.8)) +
  stat_summary(fun = "mean",
               geom = "point",
               position = position_dodge(width = 0.8)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               width = .1,
               position = position_dodge(width = 0.8)) +
  scale_fill_viridis_d(option = "E") +
  scale_y_continuous(name = "Interest score (1-7)",
                     breaks = c(1:7)) +
  theme_classic()

#è®¡ç®—ANOVA
mod_factorial <- aov_ez(id = "user_id",
                        data = dodge_value, 
                        within = c("condition", "question_content"),
                        dv = "value", 
                        type = 3,
                        include_aov = TRUE,
                        anova_table = list(es = "pes"),
                        na.rm = TRUE) 

factorial_output <- mod_factorial$anova_table %>% 
  tidy()

mod_factorial

```
```{r}
#è®¡ç®—æ˜¯å¦å¾®ç¬‘  æ•°æ®æ²»ç†

# è¯»å–æ•°æ®
df <- read.csv("data/behavior/all_data_df.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„



dodge_value <- df %>%
  mutate(condition = paste0(participant_condition, other_condition))


#å­˜è¡¨
write.csv(dodge_value, "all_data_condition.csv", row.names = FALSE)

```

```{r}
#è®¡ç®—æ˜¯å¦å¾®ç¬‘ ç›¸å…³æ€§

dodge_value  <- read.csv("all_data_condition.csv")  # æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„

library(dplyr)
library(ggplot2)
library(viridis)
position = position_dodge(width = 0.8)



dodge_value %>%
  ggplot(aes(y = measure, x = question_content, fill = condition)) +
  geom_violin(alpha = 0.5, position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.2,
               alpha = 0.7,
               position = position_dodge(width = 0.8)) +
  stat_summary(fun = "mean",
               geom = "point",
               position = position_dodge(width = 0.8)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               width = .1,
               position = position_dodge(width = 0.8)) +
  scale_fill_viridis_d(option = "E") +
  scale_y_continuous(name = "Interest score (1-7)",
                     breaks = c(1:7)) +
  theme_classic()

#è®¡ç®—ANOVA
mod_factorial <- aov_ez(id = "user_id",
                        data = dodge_value, 
                        within = c( "question_content","condition"),
                    
                        dv = "measure", 
                        type = 3,
                        include_aov = TRUE,
                        anova_table = list(es = "pes"),
                        na.rm = TRUE) 

factorial_output <- mod_factorial$anova_table %>% 
  tidy()

mod_factorial
```

```{r}
# çœ‹relationshipå’Œmeasureçš„ç›¸å…³æ€§

df <- read_csv("all_data_srm_all.csv")
df %>% 
  ggplot(aes(x = relationship, y = measure)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  scale_x_continuous(name = "relationship", 
                     breaks = c(1:9)) + 
  scale_y_continuous(name = " measure", 
                     breaks = c(1:6))

library(correlation)
correlation(data = df, 
            select = "relationship", 
            select2 = "measure",  
            method = "spearman",
            alternative = "two.sided")


#æŒ‰ç…§é—®é¢˜åˆ†ç»„
library(purrr)

# 1. æŒ‰ question_content åˆ†ç»„
grouped <- df %>%
  group_by(question_content) %>%
  group_split()

# 2. å¯¹æ¯ä¸€ç»„è¿è¡Œ correlation()
cor_list <- map(grouped, ~ correlation(select(., relationship, measure), method = "spearman"))

# 3. åŠ ä¸Šåˆ†ç»„åå¹¶ç»„åˆæˆä¸€ä¸ªè¡¨
names(cor_list) <- sapply(grouped, function(x) unique(x$question_content))
cor_combined <- bind_rows(cor_list, .id = "question_content")

# æŸ¥çœ‹
print(cor_combined)
```
```{r}
#åˆå¹¶æ–°çš„è¡¨ all_data

library(tidyverse)

# å®šä¹‰æ–‡ä»¶è·¯å¾„åˆ—è¡¨
file_paths <- c(
  "data/behavior/mkreal_meeting_experiment_prolific1.csv",
  "data/behavior/mkreal_meeting_experiment_prolific2.csv",
  "data/behavior/mkreal_meeting_experiment_prolific3.csv",
  "data/behavior/mkreal_meeting_experiment_prolific4.csv",
  "data/behavior/mkreal_meeting_experiment_prolific5.csv",
  "data/behavior/mkreal_meeting_experiment_prolific6.csv",
  "data/behavior/pilot_mkprolific_participant_real_21.csv",
  "data/behavior/pilot_mkprolific_participant_real_22.csv",
  "data/behavior/pilot_mkprolific_participant_real_31.csv",
  "data/behavior/pilot_mkprolific_participant_real_32.csv"
)

# åˆ›å»ºç©ºåˆ—è¡¨å­˜å‚¨å¤„ç†åçš„æ•°æ®
all_data_list <- list()

# éå†æ‰€æœ‰æ–‡ä»¶è·¯å¾„
for (file_path in file_paths) {
  # è¯»å–CSVæ–‡ä»¶
  df <- read_csv(file_path, show_col_types = FALSE)
  
  # æå–æ‰€éœ€åˆ—å - ä½¿ç”¨å•æ•°å½¢å¼åŒ¹é…
  sid_col <- names(df)[str_detect(names(df), "session\\.config\\.id")]
  dyad_col <- names(df)[str_detect(names(df), "dyad$")]
  user_id_col <- names(df)[str_detect(names(df), "user_id$")]
  other_id_col <- names(df)[str_detect(names(df), "other_id$")]
  part_cond_col <- names(df)[str_detect(names(df), "participant_condition$")]
  other_cond_col <- names(df)[str_detect(names(df), "other_condition$")]
  
  # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¿…éœ€çš„åˆ—
  if (length(sid_col) == 0 || 
      length(dyad_col) == 0 || 
      length(user_id_col) == 0 || 
      length(other_id_col) == 0 || 
      length(part_cond_col) == 0 || 
      length(other_cond_col) == 0) {
    message(paste("Skipping file due to missing columns:", file_path))
    next
  }
  
  # æå–é—®é¢˜åˆ—
  question_cols <- names(df)[str_detect(names(df), 
                                       "(liked$|other_liked$|conversation_quality$|video_conf_quality$)")]
  
  # åˆ›å»ºåŸºç¡€æ•°æ®æ¡†
  base_df <- df %>%
    select(
      sid = all_of(sid_col),
      dyad = all_of(dyad_col),
      user_id_raw = all_of(user_id_col),
      other_id_raw = all_of(other_id_col),
      participant_condition = all_of(part_cond_col),
      other_condition = all_of(other_cond_col)
    ) %>%
    mutate(
      user_id = paste0(sid, "__", user_id_raw),
      other_id = paste0(sid, "__", other_id_raw)
    ) %>%
    select(-user_id_raw, -other_id_raw)
  
  # è½¬æ¢é—®é¢˜åˆ—ä¸ºé•¿æ ¼å¼
  if (length(question_cols) > 0) {
    question_df <- df %>%
      select(all_of(question_cols)) %>%
      pivot_longer(
        cols = everything(),
        names_to = "question_content",
        values_to = "measure"
      )
    
    # åˆå¹¶åŸºç¡€æ•°æ®ä¸é—®é¢˜æ•°æ®
    expanded_df <- base_df[rep(seq_len(nrow(base_df)), each = length(question_cols)), ] %>%
      bind_cols(question_df)
    
    all_data_list[[file_path]] <- expanded_df
  } else {
    message(paste("No question columns found in:", file_path))
  }
}

# åˆå¹¶æ‰€æœ‰è¡¨å¹¶æ·»åŠ ç´¢å¼•
if (length(all_data_list) > 0) {
  all_data <- bind_rows(all_data_list) %>%
    mutate(Index = row_number()) %>%
    select(Index, sid, dyad, user_id, other_id, 
           participant_condition, other_condition, 
           question_content, measure)
  
  # æŸ¥çœ‹ç»“æœ
  print(glimpse(all_data))
} else {
  stop("No data was processed. Check for missing columns in input files.")
}
# ä¿å­˜
write_csv(all_data, "data/behavior/all_data.csv")



```

